#!/usr/bin/env bash
set -euo pipefail

SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"
TELEGRAM_BOT_TOKEN="${TELEGRAM_BOT_TOKEN:-}"
TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID:-}"

WINDOW_MIN="${WINDOW_MIN:-60}"

SINCE_UTC="$(date -u -d "${WINDOW_MIN} minutes ago" "+%Y-%m-%d %H:%M:%S")"
NOW_UTC="$(date -u "+%Y-%m-%d %H:%M:%S")"

EFFECTIVE=$(jq -r ".pairs[]" /root/hyperliquid-mm-bot-complete/runtime/effective_active_pairs.json 2>/dev/null || true)

# Rotation count
ROT_COUNT=$(journalctl -u mm-policy-reconcile.service --since "${SINCE_UTC} UTC" --until "${NOW_UTC} UTC" --no-pager | grep -c "Effective_pairs:" || echo 0)

# Rotation stability check (last 3 cycles)
ROT_LAST3=$(journalctl -u mm-policy-reconcile.service --no-pager -n 200 | grep "Effective_pairs:" -A6 | grep -E "^[A-Z]" | awk "{print \$NF}" | paste -sd" " - | tail -3)

RS1=$(echo "$ROT_LAST3" | sed -n "1p")
RS2=$(echo "$ROT_LAST3" | sed -n "2p")
RS3=$(echo "$ROT_LAST3" | sed -n "3p")

RST="changed"
if [ -n "$RS1" ] && [ "$RS1" = "$RS2" ] && [ "$RS2" = "$RS3" ]; then
  RST="stable"
fi

SUBMIT_RAW="$(journalctl -u mm-bot.service --since "${SINCE_UTC} UTC" --until "${NOW_UTC} UTC" --no-pager | grep "submit: pair" || true)"

awk -v OFS="	" '
  function abs(x){return x<0?-x:x}
  BEGIN{ }
  {
    if (match($0,/pair=([A-Za-z0-9]+)/,p) && match($0,/size=([0-9.]+)/,s) && match($0,/price=([0-9.]+)/,r)) {
      pair=p[1]; sz=s[1]+0; px=r[1]+0; notional=sz*px
      subm[pair]+=1
      sumN[pair]+=notional
    }
  }
  END{
    for (pair in subm){
      avgN = (subm[pair]>0 ? sumN[pair]/subm[pair] : 0)
      printf("%s: %d submits @ ~$%.2f avg\n", pair, subm[pair], avgN)
    }
  }
' <<< "$SUBMIT_RAW" > /tmp/mm_hourly.txt

REPORT_HEADER="⏱️ Hourly MM Summary (last ${WINDOW_MIN} min)
UTC: ${SINCE_UTC} → ${NOW_UTC}
Effective pairs: $(echo "$EFFECTIVE" | xargs)
Rotations_60m: ${ROT_COUNT}
Rotation_Stability: ${RST}"

REPORT_TABLE="$(cat /tmp/mm_hourly.txt 2>/dev/null || echo "(no recent submits)")"

REPORT="${REPORT_HEADER}

${REPORT_TABLE}"

if [ -n "$SLACK_WEBHOOK_URL" ]; then
  curl -s -X POST -H "Content-type: application/json" \
    --data "$(jq -Rn --arg t "$REPORT" '{text:$t}')" \
    "$SLACK_WEBHOOK_URL" >/dev/null 2>&1 || true
fi

if [ -n "${TELEGRAM_BOT_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
  TG_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
  curl -s -X POST "$TG_API" \
    -d "chat_id=${TELEGRAM_CHAT_ID}" \
    --data-urlencode "text=${REPORT}" >/dev/null 2>&1 || true
fi
